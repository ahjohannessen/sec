version: '3.8'
services:

  volumes-provisioner:
     image: hasnat/volumes-provisioner
     env_file:
       - shared.env
     environment:
       PROVISION_DIRECTORIES: "1000:1000:0755:/tmp/certs"
     volumes:
       - "$SEC_GENCERT_CERTS_PATH:/tmp/certs"
     network_mode: none

  cert-gen:
     image: quay.io/ahjohannessen/es-gencert-cli:1.0.2
     env_file:
       - shared.env
     entrypoint: bash
     command: >
       -c "es-gencert-cli create-ca -out /tmp/certs/ca &&
           es-gencert-cli create-node -ca-certificate /tmp/certs/ca/ca.crt -ca-key /tmp/certs/ca/ca.key -out \
           /tmp/certs/node -ip-addresses $SEC_GENCERT_IP_ADDRESSES -dns-names $SEC_GENCERT_DNS_NAMES"
     user: "1000:1000"
     volumes:
       - "$SEC_GENCERT_CERTS_PATH:/tmp/certs"
     network_mode: none
     depends_on:
       - volumes-provisioner

  es1:
    image: quay.io/ahjohannessen/es-v6:latest
    env_file:
      - shared.env
    environment:
      EVENTSTORE_CLUSTER_SIZE: 3
      EVENTSTORE_GOSSIP_SEED: "${SEC_ESC_2_IP}:2113,${SEC_ESC_3_IP}:2113"
      EVENTSTORE_ADVERTISE_HTTP_PORT_TO_CLIENT_AS: '2114'
    volumes:
      - "$SEC_GENCERT_CERTS_PATH:/certs"
    ports:
      - 2114:2113
    networks:
      es_cluster_network:
        ipv4_address: "$SEC_ESC_1_IP"
    depends_on:
      - cert-gen

  es2:
    image: quay.io/ahjohannessen/es-v6:latest
    env_file:
      - shared.env
    environment:
      EVENTSTORE_CLUSTER_SIZE: 3
      EVENTSTORE_GOSSIP_SEED: "${SEC_ESC_1_IP}:2113,${SEC_ESC_3_IP}:2113"
      EVENTSTORE_ADVERTISE_HTTP_PORT_TO_CLIENT_AS: '2115'
    volumes:
      - "$SEC_GENCERT_CERTS_PATH:/certs"
    ports:
      - 2115:2113
    networks:
      es_cluster_network:
        ipv4_address: "$SEC_ESC_2_IP"
    depends_on:
      - cert-gen

  es3:
    image: quay.io/ahjohannessen/es-v6:latest
    env_file:
      - shared.env
    environment:
      EVENTSTORE_CLUSTER_SIZE: 3
      EVENTSTORE_GOSSIP_SEED: "${SEC_ESC_1_IP}:2113,${SEC_ESC_2_IP}:2113"
      EVENTSTORE_ADVERTISE_HTTP_PORT_TO_CLIENT_AS: '2116'
    volumes:
      - "$SEC_GENCERT_CERTS_PATH:/certs"
    ports:
      - 2116:2113
    networks:
      es_cluster_network:
        ipv4_address: "$SEC_ESC_3_IP"
    depends_on:
      - cert-gen

networks:
  es_cluster_network:
    name: es-cluster-net
    ipam:
      driver: default
      config:
        - subnet: "$SEC_ESC_SUBNET"